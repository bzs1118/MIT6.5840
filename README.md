# MIT6.5840
2023Springè¯¾ç¨‹é“¾æ¥https://pdos.csail.mit.edu/6.824/schedule.html
# LAB1: MapReduce
MapReduceæ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºå¤„ç†å’Œç”Ÿæˆå¤§æ•°æ®é›†ã€‚å®ƒæœ€åˆç”±Googleå¼€å‘ï¼Œåæ¥æˆä¸ºå¤„ç†å¤§è§„æ¨¡æ•°æ®é›†çš„æµè¡Œæ–¹æ³•ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒä¸­ã€‚MapReduceæ¨¡å‹ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼šMapé˜¶æ®µå’ŒReduceé˜¶æ®µã€‚

Mapé˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œè¾“å…¥æ•°æ®é›†è¢«åˆ†æˆç‹¬ç«‹çš„å°å—ï¼Œè¿™äº›å°å—å¹¶è¡Œåœ°ç”±å¤šä¸ªMapä»»åŠ¡å¤„ç†ã€‚æ¯ä¸ªMapä»»åŠ¡å¤„ç†ä¸€å°å—æ•°æ®ï¼Œå¹¶ç”Ÿæˆä¸€ç»„ä¸­é—´é”®å€¼å¯¹ï¼ˆkey-value pairsï¼‰ä½œä¸ºè¾“å‡ºã€‚

Reduceé˜¶æ®µï¼šæ¥ç€ï¼Œåœ¨Reduceé˜¶æ®µï¼Œå¯¹Mapé˜¶æ®µè¾“å‡ºçš„æ‰€æœ‰ä¸­é—´é”®å€¼å¯¹è¿›è¡Œå¤„ç†ã€‚å…·æœ‰ç›¸åŒé”®çš„å€¼è¢«åˆ†ç»„åœ¨ä¸€èµ·ï¼Œå¹¶ä¼ é€’ç»™Reduceä»»åŠ¡ã€‚æ¯ä¸ªReduceä»»åŠ¡æ¥æ”¶æŸä¸ªé”®åŠå…¶å¯¹åº”çš„å€¼é›†åˆï¼Œç„¶ååˆå¹¶è¿™äº›å€¼ä»¥å½¢æˆä¸€ç»„è¾ƒå°çš„å€¼é›†åˆã€‚æœ€ç»ˆï¼ŒReduceé˜¶æ®µçš„è¾“å‡ºå¯ä»¥æ˜¯æ•°æ®çš„ä¸€ä¸ªæ–°çš„ã€æ›´å°çš„é›†åˆï¼Œæˆ–æ˜¯å¯¹æ•°æ®çš„æ€»ç»“å’Œåˆ†æç»“æœã€‚

æœ¬å®éªŒé‡‡ç”¨äº†æœ€ç»å…¸çš„word countä»»åŠ¡ï¼šç»Ÿè®¡è®¸å¤šæ–‡ä»¶ä¸­çš„æ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ã€‚

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ–‡ä»¶æ•°é‡éå¸¸åºå¤§ï¼Œæˆ‘ä»¬éœ€è¦åˆ‡åˆ†è¿™äº›æ–‡ä»¶ï¼Œåœ¨HDFS(Hadoop Distributed File system)ä¸­æ¯ä¸ªsplité€šå¸¸æ˜¯128MBï¼Œè€ŒGFS(Google File System)æ¯ä¸ªsplité€šå¸¸æ˜¯64MBã€‚æ¯ä¸ªMap workerå¯ä»¥æ¥æ”¶å¤šä¸ªæ–‡ä»¶splitsï¼Œç„¶åå°†ç»Ÿè®¡ç»“æœå†™å…¥åˆ°æœ¬åœ°ç£ç›˜ä¸­ã€‚åœ¨Mapä»»åŠ¡å®Œæˆè¿‡åï¼ŒReduce workersè¯»å–è¿™äº›ä¸­é—´æ–‡ä»¶ï¼Œå¯¹ç»“æœè¿›è¡Œæ±‡æ€»ã€‚ç”±äºæ‰§è¡ŒMapä»»åŠ¡å’ŒReduceä»»åŠ¡é€šå¸¸æ˜¯ä¸åŒçš„æœºå™¨ï¼Œè¿™éœ€è¦ä½¿ç”¨Networkè¿›è¡Œä¼ è¾“ï¼Œé€šå¸¸ä¸ºäº†å‡å°Network I/Oï¼Œæ¯ä¸ªMap workerå¯ä»¥é€‰æ‹©å¯¹æœ¬åœ°ç»“æœè¿›è¡Œå±€éƒ¨æ±‡æ€»åå†ä¼ è¾“ç»™è¿œç¨‹çš„Reduce worker. MapRduceæ‰§è¡Œè¿‡ç¨‹å¦‚å›¾(adopted from Bryan Hooi, NUS)ï¼š
![Example Image](images/MapReduce.png)

é¦–å…ˆæˆ‘ä»¬å¯ä»¥å…ˆä»è¯¾ç¨‹å®˜ç½‘æä¾›çš„sequentialç‰ˆæœ¬çš„MapReduceå…¥æ‰‹ï¼Œäº†è§£MapReduceçš„æ‰§è¡Œè¿‡ç¨‹:
é¦–å…ˆæˆ‘ä»¬éœ€è¦ç®€å•çš„Mapå‡½æ•°å’ŒReduceå‡½æ•°ï¼š
```go
func Map(filename string, contents string) []mr.KeyValue {
	// function to detect word separators.
	ff := func(r rune) bool { return !unicode.IsLetter(r) }

	// split contents into an array of words.
	words := strings.FieldsFunc(contents, ff)

	kva := []mr.KeyValue{}
	for _, w := range words {
		kv := mr.KeyValue{Key: w, Value: "1"}
		kva = append(kva, kv)
	}
	return kva
}

func Reduce(key string, values []string) string {
	// return the number of occurrences of this word.
	return strconv.Itoa(len(values))
}
```
ä¸éš¾çœ‹å‡ºï¼ŒMapå‡½æ•°è¿™é‡Œå°†æ•´ä¸ªæ–‡ä»¶ä¸­çš„è‹±æ–‡å•è¯è½¬æ¢ä¸ºäº†key-value pairsï¼Œæ¯”å¦‚: 
```
["hello": "1", "Mike": "1", "hello": "1", "Jerry": "1"]
```
å¦‚æœè¿™ä¸‰ä¸ªkeyséƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªReduce workerä¸­ï¼Œé‚£ä¹ˆæ’åºæ•´åˆåï¼ˆä¹‹åä¼šè¯´æ˜å…·ä½“å®ç°ï¼‰çš„ç»“æœä¸º:
```
["hello": ["1", "1"], "Mike": ["1"], "Jerry": ["1"]]
```
è°ƒç”¨è¯¥Reduceå‡½æ•°ä¾¿åˆ†åˆ«è¿”å›2ã€1ã€1ã€‚

è¿™ä¸¤ä¸ªå‡½æ•°ä¼šæå‰å°†å…¶ç¼–è¯‘ï¼Œç„¶åå†è¿è¡Œæ—¶ä½œä¸ºæ’ä»¶(plugin)åŠ¨æ€åŠ è½½åˆ°ç¨‹åºä¸­:
```go
mapf, reducef := loadPlugin(os.Args[1])
```

sequentialè¿™é‡Œæ„å‘³ç€ä¸é‡‡ç”¨åˆ†å¸ƒå¼è®¡ç®—ï¼Œä¸€ä¸ªæœºå™¨å®Œæˆæ‰€æœ‰çš„Mapä»»åŠ¡å’ŒReduceä»»åŠ¡ã€‚
æˆ‘ä»¬å·²ç»çŸ¥é“Mapä»»åŠ¡æ˜¯å°†è‹±æ–‡å•è¯è½¬æ¢ä¸ºkey-value pairsï¼Œç„¶åå°†å…¶å†™å…¥ä¸­é—´æ–‡ä»¶ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰ä¸­ï¼š
```go
intermediate := []mr.KeyValue{}
for _, filename := range os.Args[2:] {
	file, err := os.Open(filename)
	if err != nil {
		log.Fatalf("cannot open %v", filename)
	}
	content, err := io.ReadAll(file)
	if err != nil {
		log.Fatalf("cannot read %v", filename)
	}
	file.Close()
	kva := mapf(filename, string(content))
	intermediate = append(intermediate, kva...)
}
```
è¿™é‡Œå…¶å®å¹¶æ²¡æœ‰åˆ›å»ºçœŸæ­£çš„ä¸­é—´æ–‡ä»¶ï¼Œåªæ˜¯å†™å…¥åˆ°Arrayä¸­ï¼Œä¾›åé¢çš„Reduceä»»åŠ¡æ±‡æ€»ã€‚åé¢æˆ‘ä»¬é‡‡ç”¨çš„åˆ†å¸ƒå¼è®¡ç®—ï¼Œéœ€è¦å°†ä¸åŒçš„keysæ˜ å°„åˆ°ä¸åŒçš„Reduce workersä¸­ï¼Œå³å†™å…¥åˆ°ä¸åŒçš„ä¸­é—´æ–‡ä»¶ä¸­ã€‚

æˆ‘ä»¬å¯¹æ‰€æœ‰keysè¿›è¡Œæ’åº:
```go
sort.Sort(ByKey(intermediate))
```
è¿™æ ·åŒä¸€ä¸ªkeyå°±ä¼šèšé›†åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨Reduceå‡½æ•°ï¼š
```go
oname := "mr-out-0"
ofile, _ := os.Create(oname)

//
// call Reduce on each distinct key in intermediate[],
// and print the result to mr-out-0.
//
i := 0
for i < len(intermediate) {
	j := i + 1
	for j < len(intermediate) && intermediate[j].Key == intermediate[i].Key {
		j++
	}
	values := []string{}
	for k := i; k < j; k++ {
		values = append(values, intermediate[k].Value)
	}
	output := reducef(intermediate[i].Key, values)

	// this is the correct format for each line of Reduce output.
	fmt.Fprintf(ofile, "%v %v\n", intermediate[i].Key, output)

	i = j
}

ofile.Close()
```
è¿™æ ·æ‰€æœ‰çš„keyså’Œå…¶å¯¹åº”çš„æ•°é‡éƒ½ä¼šå†™å…¥åˆ°"mr-out-0"æ–‡ä»¶ä¸­ã€‚å®Œæˆäº†å•ä¸ªæœºå™¨ä¸Šçš„MapReduceä»»åŠ¡ã€‚è¯¥éƒ¨åˆ†å…·ä½“ä»£ç æ–‡ä»¶åœ¨src/main/mrsequential.goä¸­ã€‚
å½“ç„¶ä½ ä¼šå‘ç°è¿™é‡Œçš„é»˜è®¤Mapå‡½æ•°å¹¶ä¸é«˜æ•ˆï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨in-mapper combinerç­–ç•¥ï¼Œå³æ±‡æ€»å±€éƒ¨çš„ç»“æœï¼Œä¾‹å¦‚"hello" ç»Ÿè®¡ä¸º"2"å†ä¼ ç»™Reduce workerï¼Œå½“ç„¶ä¹Ÿéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹Reduceå‡½æ•°ã€‚

# LAB2: Raft
Raftå®˜ç½‘çš„å¯äº¤äº’æ€§åŠ¨ç”»å¯¹äºç†è§£è®ºæ–‡ä¸­çš„ç»†èŠ‚éå¸¸æœ‰å¸®åŠ©https://raft.github.io
Raftæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç†è§£èµ·æ¥ç›¸å¯¹å®¹æ˜“çš„ä¸€è‡´æ€§ç®—æ³•/åè®®ã€‚ä¸€è‡´æ€§å¯¹äºfault-tolerant systemséå¸¸é‡è¦ï¼ŒRafté€šè¿‡å‡ ä¸ªé‡è¦çš„ç‰¹æ€§æ¥å®ç°ä¸€è‡´æ€§ï¼ˆè®ºæ–‡Figure 3ï¼‰ï¼š
*  __Election Safety__: at most one leader can be elected in a given term.
*  __Leader Append-Only__: a leader never overwrites or deletes entries in its log; it only appends new entries.
*  __Log Matching__: if two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index.
*  __Leader Completeness__: if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.
*  __State Machine Safety__: if a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index.

æ¢è¨€ä¹‹ï¼š
* æŸä¸€ä»»æœŸåªæœ‰ä¸€ä¸ªLeaderã€‚
* Leaderä¸ä¼šåˆ é™¤è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼Œåªä¼šå¢åŠ ã€‚
* å½“ä¸¤ä¸ªæ—¥å¿—ä¸­çš„æŸæ¡ç›®ç´¢å¼•å’Œè¯¥æ¡ç›®çš„ä»»æœŸåŒ¹é…ï¼Œæˆ‘ä»¬æ‰è¯´è¿™ä¸¤ä¸ªæ—¥å¿—åŒ¹é…ã€‚
* å¦‚æœæŸä¸€ä¸ªæ—¥å¿—çš„æ¡ç›®è¢«æäº¤äº†ï¼Œé‚£ä¹ˆåç»­çš„é¢†å¯¼è€…ä¸€å®šæœ‰è¿™ä¸€éƒ¨åˆ†æ¡ç›®ï¼ˆæ¡ç›®éœ€è¦å¤§å¤šæ•°æœºå™¨æ‹¥æœ‰æ‰å¯ä»¥æäº¤ + æ‹¥æœ‰æœ€æ–°æ¡ç›®çš„Raftæ‰å¯ä»¥è¢«é€‰ä¸¾ä¸ºLeaderï¼‰ã€‚
* åŒä¸€ä¸ªç´¢å¼•çš„æ¡ç›®ä¸å¯ä»¥è¢«å¤šæ¬¡æäº¤ã€‚

æœ¬LABä¸­æ— è®ºRaftæ˜¯Followerï¼ŒLeaderï¼Œè¿˜æ˜¯Candidateï¼Œå®ƒä»¬ä¹‹é—´éƒ½é€šè¿‡RPCæ¥äº¤æ¢ä¿¡æ¯ã€‚
å¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

æœåŠ¡å±‚è°ƒç”¨Make()æ¥åˆ›å»ºä¸€ä¸ªä¸ªRaft peerï¼Œåˆ›å»ºå®Œæˆä¹‹åï¼Œä¼šæ—¶ä¸æ—¶çš„å‘å„ä¸ªRaftå‘é€commandä¿¡æ¯ï¼ˆé€šè¿‡è°ƒç”¨Start(command)ï¼‰ï¼Œå½“ç„¶åªæœ‰Leaderæ‰ä¼šåº”ç­”ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦é¡ºåˆ©å®Œæˆé€‰ä¸¾è¿‡ç¨‹ï¼Œå¹¶ä¸”Leaderéœ€è¦é¡ºåˆ©åœ°å°†æ—¥å¿—æ¡ç›®å‘é€ç»™å…¶ä»–æœºå™¨ã€‚å½“å¤§éƒ¨åˆ†æœºå™¨éƒ½æ”¶åˆ°è¯¥æ¡ç›®åï¼ŒLeaderä¼šåœ¨ä¸‹ä¸€æ¬¡çš„RPCä¸­é€šè¿‡commitIndexæ¥å‘ŠçŸ¥å…¶ä»–é€‰æ‰‹æˆ‘å·²ç»æŠŠè¿™ä¹‹å‰çš„ä¿¡æ¯éƒ½åº”ç”¨åˆ°çŠ¶æ€æœºï¼Œå…¶ä»–é€‰æ‰‹æ‰å¯ä»¥åº”ç”¨åˆ°çŠ¶æ€æœºã€‚æœ¬LABé€šè¿‡æ¨¡æ‹Ÿå°†åº”ç”¨çš„ä¿¡æ¯é€šè¿‡apply channelå‘é€ç»™æµ‹è¯•ç¨‹åºæ¥æ¨¡æ‹Ÿè¿™ä¸ªåº”ç”¨çš„è¿‡ç¨‹ã€‚æƒ³è¦é€šè¿‡æ‰€æœ‰æµ‹è¯•ç¨‹åºï¼Œéœ€è¦è€ƒè™‘åˆ°æ‰€æœ‰è‹›åˆ»çš„æ¡ä»¶ï¼šä¾‹å¦‚æŸä¸ªRaftçªç„¶å´©æºƒï¼Œç½‘ç»œä¸ç¨³å®šé€ æˆç–¯ç‹‚ä¸¢åŒ…ï¼Œè€Œä¸”æœ‰äº›æµ‹è¯•ç¨‹åºéœ€è¦ä½ åœ¨è§„å®šæ—¶é—´å®Œæˆï¼Œå› æ­¤éœ€è¦åŠ é€ŸæŸä¸€éƒ¨åˆ†ä»£ç ä½¿å¾—Followerå°½å¿«èµ¶ä¸ŠLeaderçš„è¿›åº¦... åœ¨åç»­çš„æ—¥å¿—æŒä¹…åŒ–å’Œåº”ç”¨å¿«ç…§éƒ¨åˆ†ä¼šå°†ä½ æœ¬å¯ä»¥é€šè¿‡2Aã€2Bæµ‹è¯•çš„ä»£ç å­˜åœ¨çš„é—®é¢˜éƒ½æš´éœ²å‡ºæ¥ã€‚

æƒ³è¦å®Œæˆæœ¬LABï¼Œä¸€ä¸ªRaft Structureå¤§æ¦‚å¦‚ä¸‹ï¼š
```go
type Raft struct {
	mu        sync.Mutex          // Lock to protect shared access to this peer's state
	peers     []*labrpc.ClientEnd // RPC end points of all peers
	persister *Persister          // Object to hold this peer's persisted state
	me        int                 // this peer's index into peers[]
	dead      int32               // set by Kill()

	// Your data here (2A, 2B, 2C).
	// Look at the paper's Figure 2 for a description of what
	// state a Raft server must maintain.

	// Persistent state on all servers:
	currentTerm int
	votedFor    int
	log         []Log
	// for snapshot
	lastIncludedIndex int
	lastIncludedTerm  int

	// Volatile state on all servers:
	commitIndex int
	lastApplied int
	snapShot    []byte

	// Volatile state on leaders:
	nextIndex  []int
	matchIndex []int

	// Other states:
	rule      int
	voteCount int
	time      *Time
	applyChan chan ApplyMsg
}

```

åœ¨è¿›è¡Œè¿™ä¸ªLABæ—¶ï¼Œä½ å¯èƒ½é‡åˆ°ä½çº§é”™è¯¯å¦‚ï¼šæ­»é”ã€æ•°ç»„è¶…å‡ºç´¢å¼•ï¼ˆé€»è¾‘é”™è¯¯å¯¼è‡´ï¼‰ã€æŠ‘æˆ–æ˜¯æ²¡æ³¨æ„åˆ°è®ºæ–‡ä¸­çš„ç»†èŠ‚å¯¼è‡´æ²¡æœ‰è¾¾æˆä¸€è‡´ã€æŠ‘æˆ–æ˜¯æ²¡æœ‰â€œè¿åˆâ€æµ‹è¯•ç¨‹åºï¼Œè€Œå¯¼è‡´æµ‹è¯•ä¸é€šè¿‡ã€‚æˆ‘è¿™é‡Œæœ‰å‡ æ¡Debugç»éªŒä¹‹è°ˆï¼š

* __Dprintf__:è¿™æ˜¯MITæ¨èçš„â€œç¬¨åŠæ³•â€ï¼Œä½†ä¹Ÿæ˜¯æœ€ç›´æˆªäº†å½“æœ€å¿«å®šä½é—®é¢˜æ‰€åœ¨çš„åŠæ³•ï¼åœ¨ä½ æ€€ç–‘çš„åœ°æ–¹æ‰“å°å°½å¯èƒ½è¯¦ç»†çš„ä¿¡æ¯ã€‚
* ä¸è¦æ”¾è¿‡è®ºæ–‡ä¸­çš„ç»†èŠ‚ï¼Œæœ‰æ—¶å€™è®ºæ–‡ä¸­çš„ç»†èŠ‚è¿˜ä¸å¤Ÿï¼Œå¯ä»¥å»å®˜ç½‘åŠ¨ç”»è‡ªå®šä¹‰caseæ¥è§£å†³ä½ çš„ç–‘æƒ‘ï¼
* å½“ä½ ä»¥ä¸ºæŠ“ä½äº†æ‰€æœ‰ç»†èŠ‚ä¹Ÿæ²¡å‘ç°é—®é¢˜ï¼Œé‚£å°±å¯ä»¥å»æµ‹è¯•ç¨‹åºé‚£é‡Œæ‰¾ç­”æ¡ˆï¼Œè™½ç„¶é˜…è¯»å¤§é‡çš„æµ‹è¯•ç¨‹åºéå¸¸æŠ˜ç£¨ã€‚ã€‚ã€‚ä½†æ­£æ˜¯è¿™æ ·æˆ‘æ‰å‘ç°äº†æˆ‘åœ¨åº”ç”¨å¿«ç…§å¯¼è‡´çš„æ­»é”é—®é¢˜æ˜¯æµ‹è¯•ç¨‹åºå’Œæˆ‘å…±åŒäº§ç”Ÿçš„ï¼šæˆ‘åœ¨SnapShotå‡½æ•°é‡Œå‘channelå‘é€å¿«ç…§ï¼Œä½†æ˜¯åŒæ—¶æµ‹è¯•ç¨‹åºé‡Œéœ€è¦åœ¨è°ƒç”¨SnapShotè¿”å›åæ‰ä¼šä»channelé‡Œæ¥å—ä¿¡æ¯ã€‚è¦ä¹ˆæˆ‘ä¿®æ”¹æµ‹è¯•ç¨‹åºï¼Œåœ¨SnapShotè°ƒç”¨å‰åŠ goï¼Œè¦ä¹ˆæˆ‘ä¸åœ¨è¿™ä¸ªå‡½æ•°é‡Œåº”ç”¨å¿«ç…§ã€‚æ‰€ä»¥å¦‚æœä½ ä¸çŸ¥é“æµ‹è¯•å‡½æ•°çš„å…·ä½“åº”ç”¨ï¼Œå³ä½¿ä½ çš„é€»è¾‘æ­£ç¡®ï¼Œä¹Ÿå¯èƒ½ä¼šè¿‡ä¸äº†æµ‹è¯•ã€‚

# 2A: Leader election
é€‰ä¸¾Leaderçš„å¤§è‡´æµç¨‹å°±æ˜¯æŸä¸€ä¸ªFollowerç­‰å¾…Leaderçš„ä¿¡æ¯è¶…æ—¶ï¼Œå˜èº«ä¸ºCandidateï¼Œç„¶åå‘å…¶ä»–äººrequest votesï¼Œå¦‚æœè·å¾—è¶…åŠæ•°çš„é€‰ç¥¨ä¾¿æˆä¸ºLeaderï¼Œå‘å…¶ä»–äººå‘é€AppendEntrieså‘½ä»¤ï¼ˆå¹¶ä¸æ˜¯çœŸçš„æœ‰æ—¥å¿—æ¡ç›®ï¼‰ã€‚å¦‚ä½•æ‰èƒ½è·å¾—ä»–äººçš„é€‰ç¥¨å’Œå¦‚ä½•æ‰èƒ½ä¿æŒLeaderèº«ä»½è®ºæ–‡ä¸­æœ‰è¯¦ç»†æè¿°ï¼Œæœ‰äº›æ¨¡ç³Šçš„ç»†èŠ‚ä½ å¯ä»¥åœ¨å®˜ç½‘åŠ¨ç”»ä¸­ç§äººå®šåˆ¶æ¥è·å–ğŸ˜ã€‚æ³¨æ„å‘é€RPCé¢‘ç‡ä¸èƒ½å¤ªå¿«ä¸ç„¶ä¼šè¿‡ä¸äº†RPCs aren't too highçš„æµ‹è¯•ã€‚

# 2B: Log
è¿™ä¸€éƒ¨åˆ†æ˜¯Raftä¸­çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¸Šå±‚serviceé€šè¿‡Startå‡½æ•°å‘å„ä¸ªRaftå‘é€command,Leaderä¼šæ­£ç¡®å›åº”è¿™ä¸ªæ¡ç›®å°†ä¼šå‡ºç°çš„Indexã€‚æˆ‘ä¸€ç›´è§‰å¾—è¿™ä¸€éƒ¨åˆ†çš„å›å¤æ— å…³ç´§è¦ï¼Œåæ¥æ‰çŸ¥é“æµ‹è¯•ç¨‹åºä¼šæ£€éªŒä½ çš„Apply channelä¸­çš„indexæ˜¯å¦ä¸ä½ å›å¤Startçš„indexä¸€è‡´ã€‚å¦å¤–é‡è¦çš„ä¸€ç‚¹ï¼Œå›å¤ç»™æœåŠ¡å±‚çš„ç´¢å¼•æ˜¯ä»1å¼€å§‹çš„ï¼Œæ‰€ä»¥åœ¨å†™applyå‡½æ•°çš„æ—¶å€™æ³¨æ„è¿™ä¸€ç‚¹å°±å¯ä»¥äº†ã€‚

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœLeaderçš„é€‰ä¸¾è¿‡ç¨‹è¿‡æ…¢æˆ–è€…é¢‘ç¹è§¦å‘é€‰ä¸¾è¿‡ç¨‹ä¼šå¯¼è‡´åé¢çš„æµ‹è¯•éš¾ä»¥é€šè¿‡ã€‚è¦æŠŠæ¡å¥½Followerçš„è¶…æ—¶æ—¶é—´å’ŒLeaderå‘é€HeartBeatçš„æ—¶é—´ã€‚Labå®˜ç½‘å¯¹è¿™ä¸€éƒ¨åˆ†ä¹Ÿæœ‰è§£é‡Šã€‚

# 2C: Persistence
æœºå™¨å´©æºƒæ—¶ä¼šä»readPersistä¸­åŠ è½½å®ƒå´©æºƒå‰æŒä¹…åŒ–çš„å„ä¸ªå‚æ•°ã€‚åªéœ€è¦åœ¨æ¯ä¸ªä¿®æ”¹æŒä¹…åŒ–å‚æ•°çš„åœ°æ–¹è°ƒç”¨persistå³å¯ã€‚

NOTICE: è¿™ä¸€éƒ¨åˆ†éœ€è¦å¯¹Leaderå’ŒFollowerä¹‹é—´çš„é€šä¿¡è¿›è¡ŒåŠ é€Ÿï¼Œå¦åˆ™é•¿æ—¶é—´ä¸èƒ½è¾¾æˆä¸€è‡´ä¼šè¿‡ä¸äº†æµ‹è¯•ã€‚å¦‚æœLeaderå‘é€çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å’Œä»»æœŸä¸Followerä¸ç¬¦ï¼Œæˆ‘2Bçš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡RPC callä¸€æ¬¡æ¬¡é€’å‡indexï¼Œç›´åˆ°Leaderå’ŒFollowerè¾¾æˆä¸€è‡´ï¼Œä½†æ˜¯å¦‚æœLogä¸­çš„æ—¥å¿—æ¡ç›®è¿‡å¤šçš„æ—¶å€™è¿™æ ·ä¼šå¾ˆæ…¢ã€‚å› ä¸ºåœ¨æœ¬Labä¸­ï¼Œæµ‹è¯•ç¨‹åºä¼šæ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…è¿‡ç¨‹ï¼æœ‰ä¸€å®šå‡ ç‡ä¼šå°†Requestå’ŒReplyä¿¡æ¯ç›´æ¥ä¸¢æ‰ï¼ˆç›¸å…³ä»£ç åº”è¯¥æ˜¯åœ¨labrpcä¸­ï¼‰ï¼Œæˆ–è€…æŸå°æœºå™¨å´©æºƒï¼Œæˆ–è€…å°†æŸå°æœºå™¨æ–­ç½‘ â€”â€” ä¾‹å¦‚æ”¶ä¸åˆ°ä»»ä½•æ¶ˆæ¯å´ä»ç„¶ä»¥ä¸ºè‡ªå·±æ˜¯Leaderä¸åœå‘é€AppendEntriesçš„ä¿¡æ¯ã€‚æ‰€ä»¥å¿«é€Ÿè¾¾æˆä¸€è‡´æ˜¯é˜²æ­¢å‘ç”Ÿä»¥ä¸Šæ„å¤–æƒ…å†µå¯¼è‡´æµ‹è¯•å¤±è´¥çš„å…³é”®ã€‚

è¯¾ç¨‹å®˜ç½‘ç»™å‡ºçš„å»ºè®®æ˜¯åœ¨Followerå›å¤çš„æ¶ˆæ¯ä¸­å¢åŠ å…³é”®ä¿¡æ¯ï¼š
* XTerm:  term in the conflicting entry (if any)
* XIndex: index of first entry with that term (if any)
* XLen:   log length

Leaderå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š
* Case 1: leader doesn't have XTerm:
    nextIndex = XIndex
* Case 2: leader has XTerm:
    nextIndex = leader's last entry for XTerm
* Case 3: follower's log is too short:
    nextIndex = XLen

å½“ç„¶ä½ å¯ä»¥æœ‰è‡ªå·±çš„åŠ é€Ÿæ–¹å¼ï¼Œå¦‚æœå¯¹æŸç§æƒ…å†µä¸ç†è§£åº”è¯¥æ€ä¹ˆå¤„ç†ï¼Œç›´æ¥å»å®˜ç½‘åŠ¨ç”»ä¸­å®šåˆ¶çš„ä½ çš„ç–‘æƒ‘å³å¯ã€‚

# 2D: Log compaction
éšç€Logçš„ä¸æ–­æ‰©å¤§ï¼Œä¸æ–­å ç”¨å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ—§çš„Logï¼Œè€Œå°†æ—§çš„éƒ¨åˆ†ä¿¡æ¯ä¿å­˜åœ¨snapshotä¸­ã€‚å¦‚æœä¸€ä¸ªLeaderå‘ç°æŸä¸€ä¸ªFollowerå¤ªè¿‡è½åä»¥è‡³äºç°å­˜çš„Logæ— æ³•å°†å®ƒçš„ä¿¡æ¯è¡¥å…¨ï¼Œé‚£ä¹ˆå°±ä¼šå‘å®ƒå‘é€å¿«ç…§ã€‚æ­¤å¤–ï¼Œserviceä¹Ÿä¼šå‘å„ä¸ªRaftå‘é€snapshotï¼Œè¡¨ç¤ºæŸäº›ä¿¡æ¯å·²ç»è¿‡æ—¶äº†ï¼Œä½ å¯ä»¥åˆ æ‰äº†ã€‚è¿™ä¸¤éƒ¨åˆ†éƒ½å¯ä»¥ç¡®ä¿ä¸€ä¸ªFollowerå¿«é€Ÿè·Ÿä¸ŠLeaderçš„æ­¥ä¼ã€‚

é‚£ä¹ˆserviceçš„snapshotä»å“ªé‡Œæ¥çš„å‘¢ï¼ŒæŸ¥çœ‹æµ‹è¯•ç¨‹åºå¯ä»¥å‘ç°ï¼Œå½“æ—¥å¿—æ¡ç›®è¾¾åˆ°æŸä¸€ä¸ªæ•°é‡æ—¶ï¼Œä»–ä¼šç›´æ¥å°†ä½ çš„Log entriesç¼–ç ç„¶åè°ƒç”¨SnapShotï¼Œè¿™æ˜¯åœ¨æ¥å—raft applyä¿¡æ¯çš„è¿‡ç¨‹ä¸­é¡ºä¾¿åšçš„ã€‚ä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨SnapShotä¸­å°†å¿«ç…§åº”ç”¨åˆ°çŠ¶æ€æœºï¼ˆé€»è¾‘ä¸Šæœ¬è¯¥æ˜¯è¿™æ ·çš„ï¼‰ï¼Œå› ä¸ºchannelè¿™è¾¹ä½ åœ¨å‘é€å¿«ç…§ï¼Œchannelé‚£é¢éœ€è¦ç­‰å¾…SnapShotå‡½æ•°æ‰§è¡Œå®Œåæ‰ä»channelä¸­æ¥å—æ•°æ®ï¼Œå› æ­¤åœ¨SnapShotå‘é€å¿«ç…§ä¼šå¯¼è‡´Dead Lock!å¦‚æœéè¦å‘é€ï¼Œå°†æµ‹è¯•ç¨‹åºè°ƒç”¨è¯¥å‡½æ•°å‰åŠ ä¸€ä¸ª'go'å°±å¯ä»¥äº†ã€‚

æˆ‘åœ¨åšè¿™ä¸€éƒ¨åˆ†çš„æ—¶å€™ï¼Œé™¤äº†é‡åˆ°ä¸Šè¿°æ­»é”é—®é¢˜ï¼Œæµ‹è¯•ç¨‹åºå‘Šè¯‰æˆ‘Failed to reach agreement!æˆ‘ç™¾æ€ä¸å¾—å…¶è§£ï¼Œç»ˆäºå‘ç°ä»æµ‹è¯•ç¨‹åºä¸­å‘ç°ç«¯å€ªã€‚

å½“Raftå´©æºƒé‡å¯æ—¶ï¼Œæˆ‘ä¹‹å‰çš„ç†è§£æ˜¯ï¼ŒlastCommitIndexä¹Ÿå°±æ˜¯æœ€åæäº¤çš„indexåº”è¯¥æ˜¯è¯»å–å¿«ç…§çš„lastIncluded Indexï¼Œä¹Ÿå°±æ˜¯å¿«ç…§çš„æœ€åä¸€ä¸ªindexã€‚å› ä¸ºæ—¢ç„¶æˆ‘ä»¬å·²ç»æŒä¹…åŒ–äº†å¿«ç…§ä¿¡æ¯ï¼Œä¸ºä½•ä¸åˆ©ç”¨å¿«ç…§ä¿¡æ¯è€Œè·å¾—å°½å¯èƒ½æœ€æ–°çš„ä¿¡æ¯å‘¢ã€‚ä½†æ˜¯æµ‹è¯•ç¨‹åºåä¸ï¼Œä»–å°†æ‰€æœ‰çš„lastCommitedIndexéƒ½è®¾ç½®æˆ0ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºç´¢å¼•ä¸­çš„-1ã€‚ä¹Ÿå°±æ˜¯å´©æºƒé‡å¯æ—¶ï¼Œæ¯ä¸ªRaftæœ€åæäº¤çš„ç´¢å¼•ç›´æ¥é‡ç½®å¥½ä¼¼ä¸ºä»€ä¹ˆäº‹æ²¡å‘ç”Ÿè¿‡ğŸ˜¡ã€‚åœ¨æ²¡æœ‰æŒä¹…åŒ–å¿«ç…§ä¿¡æ¯å‰çš„2B/2Céƒ¨åˆ†ï¼Œè¿™æ ·åšéå¸¸æœ‰é“ç†ï¼Œä½†æ˜¯æœ‰äº†å¿«ç…§ä¸ºä½•ä¸ç”¨å‘¢ï¼Ÿå½“æˆ‘å‘ç°è¿™ä¸ªé—®é¢˜æ—¶å·²ç»debugåˆ°å‡ ä¹å¤±å»è€å¿ƒï¼Œäºæ˜¯æˆ‘ç›´æ¥å°†æµ‹è¯•ç¨‹åºä¸­çš„é‡å¯ä»£ç ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼ˆè¿‡ä¸äº†å°±ä¿®æ”¹ä»–ğŸ¤£ï¼‰ï¼Œå°†ä»–é‡å¯çš„lastCommitIndexè®¾ç½®æˆæˆ‘è®¤ä¸ºçš„lastIncluded Index+1è€Œä¸æ˜¯0ã€‚æ‰€ä»¥å¦‚æœä½ æŒä¹…åŒ–äº†å¿«ç…§ç›¸å…³ä¿¡æ¯ï¼Œè¯·ä¸è¦åœ¨lastCommitIndexä¸ŠåšåŠŸå¤«ï¼Œå¦åˆ™ä¼šè¿‡ä¸æ‰æµ‹è¯•ã€‚

æ‰€ä»¥æœ‰æ—¶å€™è¿‡ä¸æ‰æµ‹è¯•çš„åŸå› å¹¶ä¸æ˜¯ä½ çš„é€»è¾‘é”™è¯¯ï¼Œè€Œæ˜¯ä½ å’Œæµ‹è¯•ç¨‹åºçš„é€»è¾‘ä¸ç›¸ç¬¦ã€‚é‡åˆ°è¿™ç§é—®é¢˜å°±éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´ï¼Œæ’å‡ºå‰é¢æ‰€æœ‰æƒ…å†µï¼Œå¹¶å°è¯•å»ç†è§£æµ‹è¯•ç¨‹åºçš„é€»è¾‘ã€‚
